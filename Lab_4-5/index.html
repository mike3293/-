<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lab 4-5</title>
</head>
<body>
<div class="control">
    <div id="message"></div>
    <div id="main">
        <label>
            ID:
            <input name="newNoteData" id="id" type="number">
        </label>
        <label>
            Name:
            <input name="newNoteData" id="name" type="text">
        </label>
        <label>
            DOB:
            <input name="newNoteData" id="birth" type="date">
        </label>
    </div>
    <div class="nav">
        <button onclick="Get()">Get</button>
        <button onclick="Commit()">Commit</button>
        <button onclick="Post()">POST/PUT</button>
    </div>
</div>
<div id="select-notes"></div>


<script>
    const DBPATH = 'http://localhost:5000/api/db';
    const COMMITPATH = 'http://localhost:5000/commit';

    function Get() {
        fetch(DBPATH, { method: 'GET' })
            .then(response => response.json())
            .then(notes => {
                let container = document.getElementById('select-notes');
                container.innerHTML = '';
                notes.forEach(note => {
                    let noteContainer = document.createElement('div');

                    let deleteButton = document.createElement('button');
                    deleteButton.setAttribute('onclick', 'Delete(event)');
                    deleteButton.setAttribute('noteId', note.id);
                    deleteButton.innerText = 'Delete note';

                    noteContainer.innerHTML = `${note.id}. ${note.name}<br>${note.birth}`;
                    noteContainer.appendChild(deleteButton);
                    container.appendChild(noteContainer);
                    container.appendChild(document.createElement('hr'));

                });
            }).catch((err) => {
            console.log('Some error');
        });
    }

    async function Post() {
        let notesData = Array.from(document.getElementsByName('newNoteData')).map(a => {
            return { key: a.getAttribute('id'), value: a.value };
        });

        EditDatabase(notesData, await FindNoteById(notesData));
        Get();
    }

    async function FindNoteById(notesData) {
        let noteId = notesData[0].value;
        return await fetch(DBPATH, { method: 'GET' })
            .then(response => response.json())
            .then(jsonNotes => {
                let isId = jsonNotes.find(x => x.id == noteId);
                return isId ? noteId : false;
            });
    }

    function EditDatabase(notesData, notesId) {
        fetch(DBPATH, {
            method: notesId ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: +notesId,
                name: notesData[1].value,
                birth: notesData[2].value,
            }),
        });
    }

    function Delete(event) {
        fetch(DBPATH + '?id=' + event.target.getAttribute('noteId'), { method: 'DELETE' }).then(() => Get());
    }

    function Commit() {
        fetch(COMMITPATH, { method: 'Get' })
            .then(() => {
                let message = document.getElementById('message');
                message.innerHTML = `<span>COMMITTED</span>`;
                setTimeout(() => message.innerHTML = '', 3000);
            });
    }
</script>
</body>
</html>
